# GeneAgent 工作流教程

## 项目概述

GeneAgent 是一个基于 GPT-4 构建的语言代理，用于自动与领域特定数据库交互，为基因集分析提供功能注释。该项目包含三种不同的工作流程，每种都有其独特的方法和应用场景。

## 三种主要工作流

### 1. Cascade 工作流 (`main_cascade.py`)

**核心特点：自验证级联系统**

这是 GeneAgent 的核心工作流，采用多步骤自验证机制来确保结果的准确性和可靠性。

#### 工作流程步骤：

1. **初始分析生成**
   - 使用 GPT-4 对输入的基因集进行初始分析
   - 生成生物过程名称和详细分析
   - 输出格式：`Process: <过程名称>`

2. **过程名称验证**
   - 提取生成的过程名称
   - 生成需要验证的声明（claims）
   - 使用 AgentPhD 与多个生物数据库 API 交互进行事实验证
   - 支持的数据库包括：
     - 蛋白质复合物数据库
     - 疾病关联数据库
     - 蛋白质结构域数据库
     - 富集分析数据库
     - 通路数据库
     - 相互作用数据库
     - 基因摘要数据库
     - PubMed 文献数据库

3. **过程名称修正**
   - 基于验证结果修正原始过程名称
   - 如果声明被支持，保留原名称并进行语法修正
   - 如果部分支持，丢弃不支持的部分
   - 如果被反驳，用最重要的生物功能术语替换

4. **分析内容验证**
   - 对修正后的分析内容生成新的验证声明
   - 再次使用 AgentPhD 进行事实验证
   - 重点验证基因功能和生物过程的关联性

5. **最终总结**
   - 基于所有验证结果生成最终的基因集分析报告
   - 确保所有声明都有可靠的科学证据支持

#### 输出文件：
- `Outputs/GPT-4/MsigDB_Response_GPT4.txt` - GPT-4 原始响应
- `Outputs/GeneAgent/Cascade/MsigDB_Final_Response_GeneAgent.txt` - 最终验证后的结果
- `Verification Reports/Cascade/Claims_and_Verification_for_MsigDB.txt` - 验证报告

### 2. Chain-of-Thought 工作流 (`main_CoT.py`)

**核心特点：逐步推理思维链**

这是一个简化的工作流，采用思维链（Chain-of-Thought）提示技术来引导模型进行结构化推理。

#### 工作流程步骤：

1. **步骤1：基因功能批判性分析**
   - 对每个重要观点描述推理过程和支持信息
   - 进行深入的功能分析

2. **步骤2：基因间功能关联分析**
   - 从批判性分析中分析不同基因间的功能关联
   - 识别共同的生物学主题

3. **步骤3：生物过程名称总结**
   - 从功能关联中总结出最重要的生物过程名称
   - 提供简洁的过程命名

#### 特点：
- 无验证步骤，依赖模型内部知识
- 处理速度快，适合快速分析
- 结构化的推理过程，提高结果的逻辑性

#### 输出文件：
- `Outputs/Chain-of-Thought/MsigDB_Response_CoT.txt`

### 3. Summary 工作流 (`main_summary.py`)

**核心特点：基于验证信息的富集分析**

这个工作流利用 Cascade 工作流产生的验证信息，进行更深入的术语富集分析。

#### 工作流程步骤：

1. **验证信息提取**
   - 从 Cascade 工作流的验证报告中提取功能描述
   - 解析验证过的基因功能信息

2. **术语富集测试**
   - 对基因进行术语富集测试
   - 执行 Gene Ontology (GO) 术语测试
   - 识别功能共性和分类层次

3. **统计显著性分析**
   - 只报告统计上过度表示的术语
   - 提供生物机制或通路的假设

4. **结构化输出**
   - 高级摘要
   - 富集术语列表
   - GO 术语列表
   - 对应的基因名称

#### 输出格式：
```
Summary: <高级摘要>
Enriched Terms: <术语1>; <术语2>; <术语3>
GO Terms: <术语1>; <术语2>; <术语3>
```

#### 输出文件：
- `Outputs/EnrichedTermTest/gpt.geneagent.msigdb.summary.result.verification.txt`

## 工作流比较

| 特性 | Cascade | Chain-of-Thought | Summary |
|------|---------|------------------|---------|
| **验证机制** | 多步骤自验证 | 无验证 | 基于已验证信息 |
| **准确性** | 最高 | 中等 | 高 |
| **处理时间** | 最长 | 最短 | 中等 |
| **适用场景** | 高精度要求的研究 | 快速初步分析 | 深入的富集分析 |
| **输出详细程度** | 详细分析报告 | 结构化推理 | 富集术语列表 |

## 使用建议

### 选择 Cascade 工作流当：
- 需要高度准确和可靠的结果
- 进行正式的科学研究
- 需要可验证的科学证据支持
- 时间允许进行深入分析

### 选择 Chain-of-Thought 工作流当：
- 需要快速的初步分析
- 探索性研究阶段
- 资源有限的情况下
- 需要理解推理过程

### 选择 Summary 工作流当：
- 已有 Cascade 验证结果
- 需要术语富集分析
- 关注 GO 术语注释
- 需要统计显著性分析

## 配置和运行

### 环境配置
1. 确保已安装所需依赖包（见 `requirements.txt`）
2. 配置 OpenAI API 密钥在 `.env` 文件中
3. 准备基因集数据文件

### 运行命令
```bash
# Cascade 工作流
python main_cascade.py

# Chain-of-Thought 工作流
python main_CoT.py

# Summary 工作流（需要先运行 Cascade）
python main_summary.py
```

### 数据集
项目支持三种数据集：
- **Gene Ontology**: 1000个来自GO:BP分支的基因集
- **MsigDB**: 56个包括标志性基因集的基因集
- **NeST**: 50个来自人类癌症蛋白质组数据的基因集

## 输出解释

### Cascade 工作流输出示例
```
Process: MAPK信号通路
ERBB2、ERBB4、FGFR2、FGFR4、HRAS和KRAS基因编码的蛋白质都是MAPK信号通路的重要组成部分，该通路对细胞生长、分化和存活至关重要...
```

### 验证报告格式
验证报告包含：
- 原始声明
- 验证结果
- 支持证据
- 数据库来源

## 最佳实践

1. **数据准备**：确保基因名称格式正确，使用标准基因符号
2. **结果验证**：始终检查验证报告以了解证据质量
3. **工作流选择**：根据研究需求和时间限制选择合适的工作流
4. **结果解释**：结合领域知识解释分析结果
5. **质量控制**：对于重要研究，建议使用 Cascade 工作流

## 故障排除

### 常见问题：
1. **API 限制**：如遇到 API 调用限制，可调整请求频率
2. **基因名称错误**：确保使用标准的 HGNC 基因符号
3. **网络连接**：确保能够访问外部生物数据库 API
4. **内存不足**：对于大型基因集，可能需要增加系统内存

### 调试建议：
- 检查 `.env` 文件配置
- 验证数据文件格式
- 查看错误日志文件
- 测试网络连接

## 总结

GeneAgent 提供了三种互补的工作流程，从快速探索性分析到深入的验证研究。Cascade 工作流是核心创新，通过自验证机制大大提高了基因集分析的可靠性。选择合适的工作流程可以最大化研究效率和结果质量。
